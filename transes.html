<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Transes & Reviewers</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0m-4xv24pOPp8H49D52e0N6/AM82cTzD7x5hDIEhYKxPcmP6hU6p4D6U9rB8D2" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7FO8CEt6P4h6zM2WImPjwQXPsEMq3+s4LVnRTDkyS4Gv2+1yY2sc3By5YfG9Y+2D" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/Gf1E3aNStScegeBfu4Yp3s6FGmoA6XtF9WvVNotm3Z2T5FDu" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #388E3C;
            --primary-dark: #2B6E2F;
            --primary-light: #C8E6C9;
            --secondary: #2C3E50;
            --secondary-dark: #34495e;
            --light: #f8f9fa;
            --white: #fff;
            --info: #3498db;
            --info-light: #eaf5fb;
            --danger: #e74c3c;
            --danger-light: #fff0f0;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            --space-sm: 0.8rem; --space-md: 1.2rem; --space-lg: 1.6rem; --space-xl: 2.4rem;
            --font-family: 'Poppins', sans-serif; --font-serif: 'Lora', serif;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --border-radius: 16px;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; height: 100%; }
        body { font-family: var(--font-family); background: var(--light); color: var(--secondary); line-height: 1.6; min-height: 100%; display: flex; flex-direction: column; }
        header { background: var(--gradient); color: var(--white); padding: var(--space-sm) 0; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); height: 70px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .header-content { max-width: 1300px; margin: 0 auto; padding: 0 var(--space-lg); display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .logo { width: 40px; height: 40px; border-radius: 50%; }
        h1 { font-size: 1.5rem; font-weight: 600; margin: 0; text-align: center; flex-grow: 1; }
        main { flex-grow: 1; padding: var(--space-xl) var(--space-lg); width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        .page-container {
            width: 100%;
            max-width: 1300px;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-container.show {
            display: flex;
        }

        .selection-container h2, .viewer-container h2 { display: flex; align-items: center; gap: var(--space-sm); font-size: 1.8rem; font-weight: 600; padding-bottom: var(--space-md); border-bottom: 1px solid #eee; margin-bottom: var(--space-lg); }
        .grid-container { display: grid; gap: var(--space-md); }
        .grid-container.hidden { display: none; }
        .year-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .semester-grid, .term-grid, .subject-grid, .topic-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        
        .card { background-color: var(--white); border: 1px solid #ddd; border-radius: var(--border-radius); padding: var(--space-lg); text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 500; transition: all 0.3s ease; box-shadow: var(--card-shadow); }
        .card:hover { background-color: var(--primary-light); border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .content-wrapper { width: 100%; overflow-y: auto; border-radius: var(--border-radius); margin-top: var(--space-lg); background-color: #fdfdfd; border: 1px solid #eee; padding: var(--space-xl) clamp(1rem, 5vw, 4rem); }
        .content-body { font-family: var(--font-serif); line-height: 1.8; color: #333; max-width: 900px; margin: 0 auto; }
        .content-body h1, .content-body h2, .content-body h3 { font-family: var(--font-family); color: var(--secondary-dark); margin: 2.5em 0 1.2em 0; font-weight: 600; }
        .content-body h1 { font-size: 2.5rem; text-align: center; border: none; color: var(--primary-dark); }
        .content-body h2 { font-size: 1.8rem; border-bottom: 3px solid var(--primary-light); padding-bottom: 0.4em;}
        .content-body h3 { font-size: 1.5rem; border-left: 4px solid var(--primary); padding-left: 0.8em;}
        .content-body p { margin-bottom: 1.2em; }
        .content-body ul { list-style: none; padding-left: 0; margin-bottom: 1.2em; }
        .content-body li { padding-left: 1.5em; position: relative; margin-bottom: 0.6em;}
        .content-body li::before { content: 'â€¢'; color: var(--primary); font-weight: bold; position: absolute; left: 0; }
        
        .info-box, .nclex-question-block { margin: var(--space-lg) 0; padding: var(--space-lg); border-radius: var(--border-radius); background-color: var(--white); border: 1px solid #eee; box-shadow: var(--card-shadow); font-family: var(--font-family); }
        .info-box { border-left-width: 5px; border-left-style: solid; }
        .info-box.info { border-color: var(--info); background-color: var(--info-light); }
        .info-box.priority { border-color: var(--danger); background-color: var(--danger-light); }
        .info-box.mnemonic { border-color: var(--primary); background-color: var(--primary-light); }
        .nclex-question-block .question-stem { font-weight: 600; margin-bottom: var(--space-md); display: block; }
        .nclex-question-block .choices p { margin-left: 1em; margin-bottom: 0.8em; }
        .answer-box { margin-top: var(--space-md); padding: var(--space-sm) var(--space-md); background-color: var(--info-light); border: 1px solid var(--info); border-left: 4px solid var(--info); border-radius: 6px; }
        .rationale-box { margin-top: var(--space-sm); padding: var(--space-sm) var(--space-md); background-color: #f0fff0; border: 1px solid var(--primary-light); border-left: 4px solid var(--primary); border-radius: 6px; }
        .katex { font-size: 1.1em; }
        
        #initial-loader-overlay { position: fixed; inset: 0; background-color: rgba(248, 249, 250, 0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .loader { border: 6px solid var(--primary-light); border-top: 6px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .reset-button { display: none; align-self: center; margin-top: var(--space-lg); padding: var(--space-sm) var(--space-lg); background-color: var(--secondary); color: var(--white); border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; }
        .reset-button.show { display: inline-block; }
        footer { background: var(--gradient); color: white; padding: var(--space-sm) 0; margin-top: auto; text-align: center; font-size: 0.9rem;}
    </style>
</head>
<body>
    <div id="initial-loader-overlay"><div class="loader"></div></div>
    <header>
        <div class="header-content">
            <a href="#" id="home-link" aria-label="Back to Homepage"><img src="https://olivarezcollegetagaytay.edu.ph/img/olivarez-college-tagaytay-logo.png" alt="College Logo" class="logo"></a>
            <h1>Nursing Transes & Reviewers</h1>
            <div style="width: 50px; flex-shrink: 0;"></div>
        </div>
    </header>
    <main>
        <div class="page-container selection-container" id="selection-container">
             <h2 id="selection-title"></h2>
             <div class="grid-container year-grid" id="year-grid"></div>
             <div class="grid-container semester-grid hidden" id="semester-grid"></div>
             <div class="grid-container term-grid hidden" id="term-grid"></div>
             <div class="grid-container subject-grid hidden" id="subject-grid"></div>
             <div class="grid-container topic-grid hidden" id="topic-grid"></div>
             <div id="selection-error" style="color: var(--danger); text-align: center; margin-top: var(--space-md); display: none; padding: var(--space-md); border: 1px solid var(--danger-light); border-radius: 8px;"></div>
        </div>
        <div class="page-container viewer-container" id="viewer-container">
            <h2 id="viewer-title"></h2>
            <div class="content-wrapper" id="content-wrapper"></div>
            <button class="reset-button" id="reset-button">Go Back</button>
        </div>
    </main>
    <footer><p>&copy; <span id="current-year"></span> Olivarez College Tagaytay - Nursing Department</p></footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA2wAeG_otRW0_Zz6wnK4me91bUP3oRVfBZpRi9UJQeD5DQwIgBT1a44DZl5SP4ng7kA/exec';

        // --- DOM Elements ---
        const selectionContainer = document.getElementById('selection-container');
        const viewerContainer = document.getElementById('viewer-container');
        const contentWrapper = document.getElementById('content-wrapper');
        const loaderOverlay = document.getElementById('initial-loader-overlay');
        const selectionTitleEl = document.getElementById('selection-title');
        const viewerTitleEl = document.getElementById('viewer-title');
        const resetButton = document.getElementById('reset-button');
        const homeLink = document.getElementById('home-link');
        const selectionError = document.getElementById('selection-error');
        
        const grids = {
            year: document.getElementById('year-grid'),
            semester: document.getElementById('semester-grid'),
            term: document.getElementById('term-grid'),
            subject: document.getElementById('subject-grid'),
            topic: document.getElementById('topic-grid'),
        };
        document.getElementById('current-year').textContent = new Date().getFullYear();
        
        // --- State Management ---
        let transesData = {};
        let selectionState = { year: null, semester: null, term: null, subject: null, topic: null };
        let stateHistory = [];

        // --- Page Switching Logic ---
        function switchPage(targetPageId) {
            window.scrollTo(0,0);
            if (targetPageId === 'selection-container') {
                viewerContainer.classList.remove('show');
                selectionContainer.classList.add('show');
                resetButton.classList.remove('show');
            } else if (targetPageId === 'viewer-container') {
                selectionContainer.classList.remove('show');
                viewerContainer.classList.add('show');
                resetButton.classList.add('show');
            }
        }
        
        // --- Text Parsing Engine ---
        const parseNclexBlock = (rawBlock) => {
            let cleanText = rawBlock.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
            let questionStem = '', choicesHtml = '', answerText = '', rationaleText = '';
            const answerPattern = /(Answer:.*?(?=Rationale:|$))/i;
            const answerMatch = cleanText.match(answerPattern);
            if (answerMatch) {
                const preciseAnswerMatch = answerMatch[0].match(/(Answer:\s*(.*))/i);
                if(preciseAnswerMatch){
                    answerText = `<strong>Answer:</strong> ${preciseAnswerMatch[2].trim()}`;
                    cleanText = cleanText.replace(answerMatch[0], '').trim();
                }
            }
            const rationalePattern = /(Rationale:.*?(?=Answer:|$))/i;
            const rationaleMatch = cleanText.match(rationalePattern);
            if (rationaleMatch) {
                rationaleText = `<strong>Rationale:</strong> ${rationaleMatch[0].substring(10).trim()}`;
                cleanText = cleanText.replace(rationaleMatch[0], '').trim();
            }
            const firstChoiceIndex = cleanText.search(/\s[a-z]\)/i);
            if (firstChoiceIndex > -1) {
                questionStem = cleanText.substring(0, firstChoiceIndex).trim();
                const choicesText = cleanText.substring(firstChoiceIndex).trim();
                const choicesArray = choicesText.split(/(?=\s[a-z]\))/i);
                choicesHtml = choicesArray.filter(c => c.trim()).map(c => `<p>${c.trim()}</p>`).join('');
            } else {
                questionStem = cleanText;
            }
            let html = '<div class="nclex-question-block">';
            html += `<p class="question-stem">${questionStem.replace(/^(Multiple Choice:|SATA:|SATA \(Select All That Apply\):)\s*/i, '')}</p>`;
            html += `<div class="choices">${choicesHtml}</div>`;
            if (answerText) html += `<div class="answer-box"><p>${answerText}</p></div>`;
            if (rationaleText) html += `<div class="rationale-box"><p>${rationaleText}</p></div>`;
            html += '</div>';
            return html;
        };
        
        // ### REFINED PARSING FUNCTION ###
        const parseContent = (text) => {
            if (!text) return '<div class="content-body"><p>Content not available for this topic.</p></div>';
            
            // Helper function to bold terms before a colon
            const boldTerm = (line) => {
                // This regex finds text from the start of the line up to a colon and makes it bold.
                return line.replace(/^([A-Za-z\s/()]+:)/, '<strong>$1</strong>');
            };

            let processedText = text.replace(/{([^}]+?)}/g, '$$$$$1$$$$');
            const lines = processedText.split('\n');
            let html = '<div class="content-body">';
            let listOpen = false;
            
            const closeList = () => {
                if (listOpen) {
                    html += '</ul>';
                    listOpen = false;
                }
            };

            lines.forEach(line => {
                let trimmedLine = line.trim();
                if (trimmedLine === '') return;

                // Check for NCLEX questions first
                if (trimmedLine.match(/^(SATA:|Multiple Choice:|SATA \(Select All That Apply\):)/i)) {
                    closeList();
                    html += parseNclexBlock(trimmedLine);
                }
                // Check for H2 headers (e.g., "I.", "1.")
                else if (trimmedLine.match(/^([IVX]+|[0-9]+)\.\s/)) {
                    closeList();
                    html += `<h2>${trimmedLine}</h2>`;
                }
                // Check for H3 headers (e.g., "A.")
                else if (trimmedLine.match(/^[A-Z]\.\s/)) {
                    closeList();
                    html += `<h3>${trimmedLine}</h3>`;
                }
                // Check for special info boxes
                else if (trimmedLine.startsWith('[INFO]')) {
                    closeList();
                    html += `<div class="info-box info"><p>${boldTerm(trimmedLine.substring(6).trim())}</p></div>`;
                }
                else if (trimmedLine.startsWith('[PRIORITY]')) {
                    closeList();
                    html += `<div class="info-box priority"><p>${boldTerm(trimmedLine.substring(10).trim())}</p></div>`;
                }
                else if (trimmedLine.startsWith('[MNEMONIC]')) {
                    closeList();
                    html += `<div class="info-box mnemonic"><p>${boldTerm(trimmedLine.substring(10).trim())}</p></div>`;
                }
                // Check for list items
                else if (trimmedLine.startsWith('* ')) {
                    if (!listOpen) {
                        html += '<ul>';
                        listOpen = true;
                    }
                    html += `<li>${boldTerm(trimmedLine.substring(2))}</li>`;
                }
                // Handle all other lines as paragraphs
                else {
                    closeList();
                    // Assume it's a title if it's in all caps and short
                    if (trimmedLine.length < 50 && trimmedLine === trimmedLine.toUpperCase() && !trimmedLine.includes(':')) {
                         html += `<h1>${trimmedLine}</h1>`;
                    } else {
                         html += `<p>${boldTerm(trimmedLine)}</p>`;
                    }
                }
            });
            
            closeList(); // Ensure any open list is closed at the end
            html += '</div>';
            return html;
        };
        
        // --- Navigation Logic ---
        function renderSelectionPage(level) {
            const titleMap = {
                year: '<i class="fas fa-layer-group"></i> Select Year Level',
                semester: `<i class="fas fa-calendar-alt"></i> ${selectionState.year}`,
                term: `<i class="fas fa-tasks"></i> ${selectionState.semester}`,
                subject: `<i class="fas fa-book"></i> ${selectionState.term}`,
                topic: `<i class="fas fa-file-alt"></i> ${selectionState.subject}`
            };
            selectionTitleEl.innerHTML = titleMap[level] || 'Select';
            let items, nextLevelHandler, currentGrid;
            let currentData = transesData;
            try {
                switch (level) {
                    case 'year':
                        currentGrid = grids.year;
                        items = Object.keys(currentData).sort();
                        nextLevelHandler = (item) => { selectionState.year = item; navigateTo('semester'); };
                        break;
                    case 'semester':
                        currentGrid = grids.semester;
                        items = Object.keys(currentData[selectionState.year]).sort();
                        nextLevelHandler = (item) => { selectionState.semester = item; navigateTo('term'); };
                        break;
                    case 'term':
                        currentGrid = grids.term;
                        items = Object.keys(currentData[selectionState.year][selectionState.semester]).sort();
                        nextLevelHandler = (item) => { selectionState.term = item; navigateTo('subject'); };
                        break;
                    case 'subject':
                        currentGrid = grids.subject;
                        items = Object.keys(currentData[selectionState.year][selectionState.semester][selectionState.term]).sort();
                        nextLevelHandler = (item) => { selectionState.subject = item; navigateTo('topic'); };
                        break;
                    case 'topic':
                        currentGrid = grids.topic;
                        items = Object.keys(currentData[selectionState.year][selectionState.semester][selectionState.term][selectionState.subject]).sort();
                        nextLevelHandler = (item) => { selectionState.topic = item; displayTopic(item); };
                        break;
                }
            } catch (e) {
                console.error("Error navigating data:", e);
                selectionError.textContent = "Could not load the requested items. The data might be missing.";
                selectionError.style.display = 'block';
                return;
            }
            Object.values(grids).forEach(grid => grid.classList.add('hidden'));
            currentGrid.innerHTML = '';
            currentGrid.classList.remove('hidden');
            items.forEach(item => {
                const card = document.createElement('button');
                card.className = 'card';
                card.textContent = item;
                card.onclick = () => nextLevelHandler(item);
                currentGrid.appendChild(card);
            });
            switchPage('selection-container');
        }
        
        function navigateTo(level) {
            stateHistory.push({ ...selectionState });
            renderSelectionPage(level);
        }

        function goBack() {
            if (stateHistory.length > 0) {
                const lastState = stateHistory.pop();
                selectionState = lastState;
                let prevLevel = 'year';
                if(selectionState.subject) prevLevel = 'topic';
                else if(selectionState.term) prevLevel = 'subject';
                else if(selectionState.semester) prevLevel = 'term';
                else if(selectionState.year) prevLevel = 'semester';
                renderSelectionPage(prevLevel);
            } else {
                 renderSelectionPage('year');
            }
        }
        
        function displayTopic(topic) {
            const { year, semester, term, subject } = selectionState;
            const content = transesData[year][semester][term][subject][topic];
            viewerTitleEl.innerHTML = `<i class="fas fa-book-open"></i> ${topic}`;
            contentWrapper.innerHTML = parseContent(content);
            if (window.renderMathInElement) {
                renderMathInElement(contentWrapper, {
                    delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}]
                });
            }
            switchPage('viewer-container');
        }
        
        // --- Event Listeners ---
        resetButton.addEventListener('click', goBack);
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            selectionState = { year: null, semester: null, term: null, subject: null, topic: null };
            stateHistory = [];
            renderSelectionPage('year');
        });

        // --- Initial Data Fetch ---
        fetch(GAS_WEB_APP_URL)
            .then(response => {
                if (!response.ok) throw new Error(`Network error (Status: ${response.status})`);
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(`Apps Script Error: ${data.message}`);
                transesData = data;
                loaderOverlay.style.display = 'none';
                renderSelectionPage('year'); 
            })
            .catch(error => {
                loaderOverlay.style.display = 'none';
                selectionContainer.classList.add('show');
                selectionTitleEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                selectionError.innerHTML = `Failed to load reviewer data.<br><br><b>Details:</b> ${error.message}<br><br>Please check the script URL, deployment permissions ('Anyone'), and your internet connection.`;
                selectionError.style.display = 'block';
            });
    });
    </script>
</body>
</html>