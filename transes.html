<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Transes & Reviewers</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0m-4xv24pOPp8H49D52e0N6/AM82cTzD7x5hDIEhYKxPcmP6hU6p4D6U9rB8D2" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7FO8CEt6P4h6zM2WImPjwQXPsEMq3+s4LVnRTDkyS4Gv2+1yY2sc3By5YfG9Y+2D" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/Gf1E3aNStScegeBfu4Yp3s6FGmoA6XtF9WvVNotm3Z2T5FDu" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #388E3C;
            --primary-dark: #2B6E2F;
            --primary-light: #C8E6C9;
            
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            
            /* Sizing */
            --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem; --space-lg: 1.25rem; --space-xl: 1.75rem;
            --font-family: 'Poppins', sans-serif; --font-serif: 'Lora', serif;
            --border-radius: 12px;
        }

        html[data-theme='light'] {
            color-scheme: light;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fdfdfd;
            --text-primary: #2C3E50;
            --text-secondary: #333;
            --text-tertiary: #7f8c8d;
            --border-color: #ddd;
            --border-color-light: #eee;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --header-bg: var(--gradient);
            --header-text: #fff;
            --info: #3498db;
            --info-light: #eaf5fb;
            --danger: #e74c3c;
            --danger-light: #fff0f0;
            --success-light: #f0fff0;
        }

        html[data-theme='dark'] {
            color-scheme: dark;
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --primary-light: #2c4a2d;

            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #cccccc;
            --text-tertiary: #888888;
            --border-color: #444;
            --border-color-light: #333;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            --header-bg: #1e1e1e;
            --header-text: #e0e0e0;
            
            --info: #5dade2;
            --info-light: #213a4a;
            --danger: #f1948a;
            --danger-light: #4a2a2a;
            --success-light: #224022;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            scroll-behavior: smooth;
            height: 100%;
            font-family: var(--font-family);
            font-size: 100%; /* Base: 16px */
            -webkit-text-size-adjust: 100%; /* Prevent font scaling in landscape on iOS */
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem;
        }
        header { background: var(--header-bg); color: var(--header-text); padding: var(--space-sm) 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); height: 4rem; /* 64px */ display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; transition: background-color 0.3s; border-bottom: 1px solid var(--border-color); }
        .header-content { max-width: 1280px; margin: 0 auto; padding: 0 var(--space-lg); display: flex; align-items: center; justify-content: space-between; width: 100%; gap: var(--space-md); }
        .logo-container { display: flex; align-items: center; gap: var(--space-md); color: inherit; text-decoration: none; }
        .logo { width: 2.25rem; /* 36px */ height: 2.25rem; /* 36px */ }
        .header-title { font-size: 1.15rem; font-weight: 600; margin: 0; white-space: nowrap; }
        
        /* Theme Switch */
        .theme-switch-wrapper { display: flex; align-items: center; margin-left: auto; }
        .theme-switch { display: inline-block; height: 1.375rem; /* 22px */ position: relative; width: 2.75rem; /* 44px */ }
        .theme-switch input { display: none; }
        .slider { background-color: rgba(128,128,128,0.4); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 1.375rem; /* 22px */ }
        .slider:before { content: ""; height: 1.125rem; /* 18px */ width: 1.125rem; /* 18px */ left: 0.125rem; /* 2px */ bottom: 0.125rem; /* 2px */ position: absolute; transition: .4s; background-color: white; border-radius: 50%; }
        .slider .fa-moon { position: absolute; left: 0.3125rem; /* 5px */ top: 0.25rem; /* 4px */ color: #f1c40f; font-size: 0.75rem; /* 12px */ opacity: 1; transition: opacity 0.2s; }
        .slider .fa-sun { position: absolute; right: 0.3125rem; /* 5px */ top: 0.25rem; /* 4px */ color: #f39c12; font-size: 0.75rem; /* 12px */ opacity: 0; transition: opacity 0.2s; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(1.375rem); /* 22px */ }
        input:checked + .slider .fa-moon { opacity: 0; }
        input:checked + .slider .fa-sun { opacity: 1; }
        html[data-theme='light'] .slider { background-color: var(--primary-light); }

        main { flex-grow: 1; padding: var(--space-lg); width: 100%; display: flex; flex-direction: column; align-items: center; }
        .page-container { width: 100%; max-width: 1280px; display: none; flex-direction: column; animation: fadeIn 0.5s ease-in-out; }
        .page-container.show { display: flex; }
        
        /* New Animated Search Bar */
        .search-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-lg);
            padding: var(--space-md) 0;
        }
        form.search-box {
            position: relative;
        }
        .input-search {
            height: 3rem; /* 48px */
            width: 3rem; /* 48px */
            border-style: none;
            padding: 0.625rem; /* 10px */
            font-size: 1rem;
            letter-spacing: 1px;
            outline: none;
            border-radius: 1.5rem; /* 24px */
            transition: all 500ms cubic-bezier(0, 0.110, 0.35, 2);
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding-right: 2.5rem; /* 40px */
            -webkit-appearance: none;
        }
        .input-search::placeholder {
            color: var(--text-tertiary);
            font-size: 1rem;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .btn-search {
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            border-style: none;
            font-size: 1.1rem;
            font-weight: bold;
            outline: none;
            cursor: pointer;
            border-radius: 50%;
            position: absolute;
            right: 0px;
            top: 0px;
            color: var(--text-tertiary);
            background-color: transparent;
            pointer-events: painted;
            z-index: 2;
        }
        form.search-box:focus-within .input-search {
            width: 28.125rem; /* 450px */
            max-width: 80vw;
            border-radius: 8px;
            border-color: var(--primary);
            padding-left: 1.25rem; /* 20px */
        }
        form.search-box:focus-within .input-search::placeholder {
            opacity: 1;
        }
        form.search-box:focus-within .btn-search {
            color: var(--primary);
        }
        #clear-search-btn {
            position: absolute;
            right: 3.25rem; /* 52px */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-tertiary);
            cursor: pointer;
            display: none;
            z-index: 3;
            opacity: 0;
            transition: opacity .3s;
        }
        form.search-box:focus-within #clear-search-btn {
            opacity: 1;
        }
        
        #breadcrumb-nav { margin-bottom: var(--space-md); font-size: 0.95rem; color: var(--text-tertiary); }
        #breadcrumb-nav a { color: var(--primary); text-decoration: none; font-weight: 500; }
        #breadcrumb-nav a:hover { text-decoration: underline; }
        #breadcrumb-nav span { margin: 0 var(--space-xs); }

        .page-title { display: flex; align-items: center; gap: var(--space-sm); font-size: 1.7rem; font-weight: 600; padding-bottom: var(--space-md); border-bottom: 1px solid var(--border-color-light); margin-bottom: var(--space-lg); }
        
        .grid-container { display: grid; gap: var(--space-md); }
        .grid-container.hidden { display: none; }
        .year-grid, .semester-grid, .term-grid { grid-template-columns: repeat(auto-fit, minmax(12.5rem, 1fr)); /* 200px */ }
        .subject-grid, .topic-grid { grid-template-columns: repeat(auto-fit, minmax(15.625rem, 1fr)); /* 250px */ }
        
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: var(--space-sm) var(--space-md); text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 6.875rem; /* 110px */ gap: var(--space-sm); }
        .card:hover { background-color: var(--primary-light); border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card i { font-size: 1.8rem; color: var(--primary); margin-bottom: var(--space-sm); }
        html[data-theme='dark'] .card:hover { color: #fff; }

        /* Search Results */
        .search-results-list { list-style: none; }
        .search-result-item a { display: block; background-color: var(--bg-secondary); padding: var(--space-md); margin-bottom: var(--space-sm); border-radius: 8px; box-shadow: var(--card-shadow); text-decoration: none; color: var(--text-primary); transition: all 0.2s ease; border-left: 4px solid var(--primary-light); }
        .search-result-item a:hover { transform: translateX(5px); border-color: var(--primary); }
        .search-result-topic { font-weight: 600; font-size: 1.1rem; }
        .search-result-path { font-size: 0.85rem; color: var(--text-tertiary); margin-top: var(--space-xs); }

        .content-wrapper { width: 100%; overflow-y: auto; border-radius: var(--border-radius); margin-top: var(--space-lg); background-color: var(--bg-tertiary); border: 1px solid var(--border-color-light); padding: var(--space-xl) clamp(1rem, 4vw, 3rem); }
        .content-body { font-family: var(--font-serif); line-height: 1.8; color: var(--text-secondary); max-width: 56.25rem; /* 900px */ margin: 0 auto; }
        .content-body h1, .content-body h2, .content-body h3 { font-family: var(--font-family); color: var(--text-primary); margin: 2.5em 0 1.2em 0; font-weight: 600; }
        .content-body h1 { font-size: 2.1rem; text-align: center; border: none; color: var(--primary); }
        .content-body h2 { font-size: 1.7rem; border-bottom: 3px solid var(--primary-light); padding-bottom: 0.4em;}
        .content-body h3 { font-size: 1.4rem; border-left: 4px solid var(--primary); padding-left: 0.8em;}
        .content-body p { margin-bottom: 1.2em; }
        .content-body ul { list-style: none; padding-left: 0; margin-bottom: 1.2em; }
        .content-body li { padding-left: 1.5em; position: relative; margin-bottom: 0.6em;}
        .content-body li::before { content: '•'; color: var(--primary); font-weight: bold; position: absolute; left: 0; }
        
        .info-box, .nclex-question-block { margin: var(--space-lg) 0; padding: var(--space-lg); border-radius: var(--border-radius); background-color: var(--bg-secondary); border: 1px solid var(--border-color-light); box-shadow: var(--card-shadow); font-family: var(--font-family); }
        .info-box { border-left-width: 5px; border-left-style: solid; }
        .info-box.info { border-color: var(--info); background-color: var(--info-light); }
        .info-box.priority { border-color: var(--danger); background-color: var(--danger-light); }
        .info-box.mnemonic { border-color: var(--primary); background-color: var(--primary-light); }
        .nclex-question-block .question-stem { font-weight: 600; margin-bottom: var(--space-md); display: block; }
        .nclex-question-block .choices p { margin-left: 1em; margin-bottom: 0.8em; }
        .answer-box { margin-top: var(--space-md); padding: var(--space-sm) var(--space-md); background-color: var(--info-light); border: 1px solid var(--info); border-left: 4px solid var(--info); border-radius: 6px; }
        .rationale-box { margin-top: var(--space-sm); padding: var(--space-sm) var(--space-md); background-color: var(--success-light); border: 1px solid var(--primary-light); border-left: 4px solid var(--primary); border-radius: 6px; }
        .katex { font-size: 1.1em; }
        
        #initial-loader-overlay { position: fixed; inset: 0; background-color: var(--bg-primary); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; transition: opacity 0.5s ease-out; }
        .loader { border: 6px solid var(--primary-light); border-top: 6px solid var(--primary); border-radius: 50%; width: 3.125rem; /* 50px */ height: 3.125rem; /* 50px */ animation: spin 1s linear infinite; }
        .loader-text { font-weight: 500; color: var(--text-primary); }

        .back-button { display: none; align-self: center; margin-top: var(--space-lg); padding: var(--space-sm) var(--space-lg); background-color: var(--text-primary); color: var(--bg-primary); border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s; }
        .back-button:hover { opacity: 0.8; }
        .back-button.show { display: inline-block; }

        #app-error { color: var(--danger); text-align: center; margin-top: var(--space-md); display: none; padding: var(--space-md); border: 1px solid var(--danger); border-radius: 8px; background-color: var(--danger-light); }
        
        footer { background: #2a2a2a; color: #e0e0e0; padding: var(--space-md) 0; margin-top: auto; text-align: center; font-size: 0.9rem; transition: background-color 0.3s;}
        html[data-theme='light'] footer {
             background: var(--gradient);
             color: white;
        }

        #back-to-top { position: fixed; bottom: 1.25rem; /* 20px */ right: 1.25rem; /* 20px */ width: 2.8125rem; /* 45px */ height: 2.8125rem; /* 45px */ background-color: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: opacity 0.3s, transform 0.3s; z-index: 999; }
        #back-to-top:hover { background-color: var(--primary-dark); }
        #back-to-top.show { display: flex; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            html {
                font-size: 93.75%; /* 15px */
            }
            
            .header-content {
                padding: 0 var(--space-md);
            }

            .header-title {
                font-size: 1.1rem;
            }

            .logo {
                width: 2rem; /* 32px */
                height: 2rem; /* 32px */
            }
            
            main {
                padding: var(--space-md);
            }
            
            .page-title {
                font-size: 1.5rem;
                margin-bottom: var(--space-md);
            }

            .grid-container {
                gap: var(--space-sm);
            }

            .year-grid, .semester-grid, .term-grid {
                grid-template-columns: repeat(auto-fit, minmax(8.75rem, 1fr)); /* 140px */
            }
            
            .subject-grid, .topic-grid {
                grid-template-columns: repeat(auto-fit, minmax(9.375rem, 1fr)); /* 150px */
            }
            
            .card {
                font-size: 1rem;
                min-height: 6.25rem; /* 100px */
                border-radius: 0.625rem; /* 10px */
            }
            
            .content-wrapper {
                padding: var(--space-lg) var(--space-md);
            }

            .content-body h1 { font-size: 1.9rem; }
            .content-body h2 { font-size: 1.5rem; }
            .content-body h3 { font-size: 1.3rem; }

            footer {
                padding: var(--space-sm) 0;
            }

            #back-to-top {
                bottom: 1rem;
                right: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            html {
                font-size: 87.5%; /* 14px */
            }
            
            .header-title {
                 /* Hiding the title on very small screens to give more space */
                display: none;
            }

            .logo-container {
                /* Adjust to account for the hidden title */
                flex-grow: 1;
                justify-content: flex-start;
            }
            
            .year-grid, .semester-grid, .term-grid, .subject-grid, .topic-grid {
                /* Ensure at least two columns fit nicely */
                grid-template-columns: repeat(auto-fit, minmax(7.5rem, 1fr)); /* 120px */
            }

            .card {
                padding: var(--space-sm);
                min-height: 5.625rem; /* 90px */
            }
            
            .content-wrapper {
                padding: var(--space-md) var(--space-sm);
            }

            .info-box, .nclex-question-block {
                padding: var(--space-md);
            }
            
            .content-body h1 { font-size: 1.7rem; }
            .content-body h2 { font-size: 1.4rem; }
            .content-body h3 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div id="initial-loader-overlay">
        <div class="loader"></div>
        <p class="loader-text">Loading Review Materials...</p>
    </div>
    <header>
        <div class="header-content">
            <a href="#" id="home-link" class="logo-container" aria-label="Back to Homepage">
                <img src="https://olivarezcollegetagaytay.edu.ph/img/olivarez-college-tagaytay-logo.png" alt="College Logo" class="logo">
                <h1 class="header-title">Nursing Reviewers</h1>
            </a>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-checkbox">
                    <input type="checkbox" id="theme-checkbox" />
                    <div class="slider">
                         <i class="fas fa-moon"></i>
                         <i class="fas fa-sun"></i>
                    </div>
                </label>
            </div>
        </div>
    </header>
    <main>
        <div id="breadcrumb-nav"></div>

        <div class="page-container selection-container" id="selection-container">
            <div class="search-container">
                <form id="search-form" class="search-box">
                    <input type="search" id="search-input" class="input-search" placeholder="Type to Search..." aria-label="Search for a topic">
                    <button type="submit" class="btn-search" aria-label="Search"><i class="fas fa-search"></i></button>
                    <button type="button" id="clear-search-btn" aria-label="Clear search"><i class="fas fa-times-circle"></i></button>
                </form>
            </div>

             <h2 class="page-title" id="selection-title"></h2>
             <div class="grid-container year-grid" id="year-grid"></div>
             <div class="grid-container semester-grid hidden" id="semester-grid"></div>
             <div class="grid-container term-grid hidden" id="term-grid"></div>
             <div class="grid-container subject-grid hidden" id="subject-grid"></div>
             <div class="grid-container topic-grid hidden" id="topic-grid"></div>
        </div>

        <div class="page-container viewer-container" id="viewer-container">
            <h2 class="page-title" id="viewer-title"></h2>
            <div class="content-wrapper" id="content-wrapper"></div>
            <button class="back-button" id="back-button">Back to Selection</button>
        </div>

        <div class="page-container search-results-container" id="search-results-container">
            <h2 class="page-title" id="search-results-title"></h2>
            <ul class="search-results-list" id="search-results-list"></ul>
        </div>
        
        <div id="app-error"></div>

    </main>
    <footer><p>&copy; <span id="current-year"></span> Olivarez College Tagaytay - Nursing Department</p></footer>

    <button id="back-to-top" title="Go to top" aria-label="Go to top"><i class="fas fa-arrow-up"></i></button>

    <script type="module">
        const App = {
            // --- Constants ---
            GAS_WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbwA2wAeG_otRW0_Zz6wnK4me91bUP3oRVfBZpRi9UJQeD5DQwIgBT1a44DZl5SP4ng7kA/exec',
            CACHE_KEY: 'nursingDataCache',
            CACHE_DURATION_MS: 24 * 60 * 60 * 1000, // 24 hours

            // --- State ---
            state: {
                transesData: {},
                selection: { year: null, semester: null, term: null, subject: null, topic: null },
                currentView: 'loading', // loading, selection, viewer, search
                isLoading: true,
                error: null,
                searchTerm: '',
            },
            
            // --- Cached Elements ---
            elements: {},

            // --- Timers ---
            debounceTimer: null,

            // --- Core Methods ---
            init() {
                this.cacheDOMElements();
                this.initTheme();
                this.bindEvents();
                this.render();
                this.fetchData();
                if (this.elements.currentYear) {
                    this.elements.currentYear.textContent = new Date().getFullYear();
                }
            },

            cacheDOMElements() {
                this.elements = {
                    loaderOverlay: document.getElementById('initial-loader-overlay'),
                    homeLink: document.getElementById('home-link'),
                    currentYear: document.getElementById('current-year'),
                    appError: document.getElementById('app-error'),
                    // Page Containers
                    selectionContainer: document.getElementById('selection-container'),
                    viewerContainer: document.getElementById('viewer-container'),
                    searchResultsContainer: document.getElementById('search-results-container'),
                    // Breadcrumbs
                    breadcrumbNav: document.getElementById('breadcrumb-nav'),
                    // Selection Page
                    selectionTitle: document.getElementById('selection-title'),
                    grids: {
                        year: document.getElementById('year-grid'),
                        semester: document.getElementById('semester-grid'),
                        term: document.getElementById('term-grid'),
                        subject: document.getElementById('subject-grid'),
                        topic: document.getElementById('topic-grid'),
                    },
                    // Viewer Page
                    viewerTitle: document.getElementById('viewer-title'),
                    contentWrapper: document.getElementById('content-wrapper'),
                    backButton: document.getElementById('back-button'),
                    // Search
                    searchForm: document.getElementById('search-form'),
                    searchInput: document.getElementById('search-input'),
                    clearSearchBtn: document.getElementById('clear-search-btn'),
                    searchResultsList: document.getElementById('search-results-list'),
                    searchResultsTitle: document.getElementById('search-results-title'),
                    // Back to Top
                    backToTopButton: document.getElementById('back-to-top'),
                    // Theme
                    themeToggle: document.getElementById('theme-checkbox'),
                };
            },

            bindEvents() {
                this.elements.homeLink?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.resetToHome();
                });
                this.elements.backButton?.addEventListener('click', () => this.navigateBack());
                
                // Search Events
                this.elements.searchForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (this.elements.searchInput) {
                        const searchTerm = this.elements.searchInput.value.trim();
                        // Only search if there's a term, otherwise just keep focus
                        if (searchTerm) {
                            this.handleSearch(searchTerm);
                        } else {
                            this.elements.searchInput.focus();
                        }
                    }
                });
                this.elements.clearSearchBtn?.addEventListener('click', () => {
                    if (this.elements.searchInput) {
                        this.elements.searchInput.value = '';
                    }
                    this.handleSearch('');
                    this.elements.searchInput?.focus();
                });

                // Scroll Event for Back to Top
                window.addEventListener('scroll', () => this.toggleBackToTopButton());
                this.elements.backToTopButton?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

                // Theme Toggle
                this.elements.themeToggle?.addEventListener('change', (e) => this.setTheme(e.target.checked ? 'dark' : 'light'));
            },

            fetchData() {
                const cached = this.getCache();
                if (cached) {
                    this.state.transesData = cached;
                    this.state.isLoading = false;
                    this.state.currentView = 'selection';
                    this.render();
                    this.fetchAndCacheInBackground(); // Check for updates silently
                } else {
                    this.fetchAndCache(); // First time fetch
                }
            },

            fetchAndCache() {
                fetch(this.GAS_WEB_APP_URL)
                    .then(response => {
                        if (!response.ok) throw new Error(`Network error (Status: ${response.status})`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) throw new Error(`Apps Script Error: ${data.message}`);
                        this.setCache(data);
                        this.state.transesData = data;
                        this.state.isLoading = false;
                        this.state.currentView = 'selection';
                        this.render();
                    })
                    .catch(error => {
                        this.state.isLoading = false;
                        this.state.error = `Failed to load reviewer data. Please check your internet connection and try again. Details: ${error.message}`;
                        this.state.currentView = 'error';
                        this.render();
                    });
            },
            
            fetchAndCacheInBackground() {
                 fetch(this.GAS_WEB_APP_URL)
                    .then(res => res.json())
                    .then(data => {
                        if (data && !data.error) {
                            this.setCache(data);
                        }
                    }).catch(console.error); // Silently fail in background
            },

            // --- Caching ---
            setCache(data) {
                const cacheData = {
                    timestamp: new Date().getTime(),
                    data: data,
                };
                localStorage.setItem(this.CACHE_KEY, JSON.stringify(cacheData));
            },

            getCache() {
                const cached = localStorage.getItem(this.CACHE_KEY);
                if (!cached) return null;

                const { timestamp, data } = JSON.parse(cached);
                if (new Date().getTime() - timestamp > this.CACHE_DURATION_MS) {
                    localStorage.removeItem(this.CACHE_KEY);
                    return null; // Cache expired
                }
                return data;
            },

            // --- Theming ---
            initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
                this.setTheme(theme);
            },

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (this.elements.themeToggle) {
                    this.elements.themeToggle.checked = theme === 'dark';
                }
            },

            // --- Navigation & State Changes ---
            resetToHome() {
                this.state.selection = { year: null, semester: null, term: null, subject: null, topic: null };
                this.state.currentView = 'selection';
                if (this.elements.searchInput) {
                    this.elements.searchInput.value = '';
                }
                this.state.searchTerm = '';
                this.render();
            },
            
            navigateTo(level, item) {
                this.state.selection[level] = item;
                const levels = ['year', 'semester', 'term', 'subject', 'topic'];
                const currentLevelIndex = levels.indexOf(level);
                for (let i = currentLevelIndex + 1; i < levels.length; i++) {
                    this.state.selection[levels[i]] = null;
                }
                this.state.currentView = 'selection';
                this.render();
            },

            navigateBack() {
                const levels = ['topic', 'subject', 'term', 'semester', 'year'];
                for (const level of levels) {
                    if (this.state.selection[level]) {
                        this.state.selection[level] = null;
                        this.state.currentView = 'selection';
                        this.render();
                        return;
                    }
                }
                this.resetToHome();
            },

            displayTopic(path) {
                this.state.selection = path;
                this.state.currentView = 'viewer';
                this.render();
            },

            handleSearch(term) {
                this.state.searchTerm = term.trim();
                if (this.elements.clearSearchBtn) {
                    this.elements.clearSearchBtn.style.display = this.state.searchTerm ? 'block' : 'none';
                }
                this.state.currentView = this.state.searchTerm ? 'search' : 'selection';
                this.render();
            },

            // --- Rendering ---
            render() {
                const { currentView, isLoading, error } = this.state;
                
                if (isLoading) {
                    this.elements.loaderOverlay.style.display = 'flex';
                    return;
                }
                
                if (this.elements.loaderOverlay.style.opacity !== '0') {
                    this.elements.loaderOverlay.style.opacity = '0';
                    setTimeout(() => { this.elements.loaderOverlay.style.display = 'none'; }, 500);
                }
                
                this.elements.selectionContainer?.classList.remove('show');
                this.elements.viewerContainer?.classList.remove('show');
                this.elements.searchResultsContainer?.classList.remove('show');
                this.elements.appError.style.display = 'none';
                
                const isSearchFocused = document.activeElement === this.elements.searchInput;
                if (!isSearchFocused) {
                   window.scrollTo(0, 0);
                }


                if (error) {
                    this.elements.appError.innerHTML = error;
                    this.elements.appError.style.display = 'block';
                } else {
                    this.renderBreadcrumbs();
                    if (currentView === 'selection') {
                        this.elements.selectionContainer?.classList.add('show');
                        this.renderSelectionPage();
                    } else if (currentView === 'viewer') {
                        this.elements.viewerContainer?.classList.add('show');
                        this.renderViewerPage();
                    } else if (currentView === 'search') {
                        this.elements.searchResultsContainer?.classList.add('show');
                        this.renderSearchResults();
                    }
                }
            },

            renderBreadcrumbs() {
                const { selection } = this.state;
                let html = '<a href="#" data-level="home">Home</a>';
                const levels = ['year', 'semester', 'term', 'subject'];
                for (const level of levels) {
                    if (selection[level]) {
                        html += `<span>/</span><a href="#" data-level="${level}">${selection[level]}</a>`;
                    } else {
                        break;
                    }
                }
                if (selection.topic && this.state.currentView === 'viewer') {
                     html += `<span>/</span>${selection.topic}`;
                }

                this.elements.breadcrumbNav.innerHTML = html;
                this.elements.breadcrumbNav.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const level = e.target.dataset.level;
                        if (level === 'home') {
                            this.resetToHome();
                        } else {
                            const tempSelection = {};
                            for(let i = 0; i < levels.length; i++) {
                                const l = levels[i];
                                if (this.state.selection[l]) {
                                    tempSelection[l] = this.state.selection[l];
                                }
                                if (l === level) break;
                            }
                            this.state.selection = tempSelection;
                            this.state.currentView = 'selection';
                            this.render();
                        }
                    });
                });
            },

            renderSelectionPage() {
                const { selection, transesData } = this.state;
                const levels = ['year', 'semester', 'term', 'subject', 'topic'];
                const icons = { year: 'fa-calendar-days', semester: 'fa-layer-group', term: 'fa-tasks', subject: 'fa-book-open', topic: 'fa-file-alt' };
                let currentLevel = 'year';
                let currentData = transesData;
                let title = '<i class="fas fa-school"></i> Select Year Level';

                for (const level of levels) {
                    if (selection[level]) {
                        currentData = currentData[selection[level]];
                        currentLevel = levels[levels.indexOf(level) + 1];
                    } else break;
                }
                
                const titleMap = {
                    semester: `<i class="fas fa-layer-group"></i> Select Semester`,
                    term: `<i class="fas fa-tasks"></i> Select Term`,
                    subject: `<i class="fas fa-book-open"></i> Select Subject`,
                    topic: `<i class="fas fa-file-alt"></i> Select Topic`
                };
                if(currentLevel !== 'year' && titleMap[currentLevel]) title = titleMap[currentLevel];

                this.elements.selectionTitle.innerHTML = title;
                Object.values(this.elements.grids).forEach(grid => grid.classList.add('hidden'));
                const currentGrid = this.elements.grids[currentLevel];
                if (!currentGrid) return;
                
                currentGrid.innerHTML = '';
                currentGrid.classList.remove('hidden');

                if (!currentData || Object.keys(currentData).length === 0) {
                    currentGrid.innerHTML = `<p>No items found for this selection.</p>`;
                    return;
                }

                Object.keys(currentData).sort().forEach(item => {
                    const card = document.createElement('button');
                    card.className = 'card';
                    card.innerHTML = `<i class="fas ${icons[currentLevel]}"></i><span>${item}</span>`;
                    card.onclick = () => {
                        if (currentLevel === 'topic') this.displayTopic({ ...selection, topic: item });
                        else this.navigateTo(currentLevel, item);
                    };
                    currentGrid.appendChild(card);
                });
            },

            renderViewerPage() {
                const { year, semester, term, subject, topic } = this.state.selection;
                const content = this.state.transesData[year][semester][term][subject][topic];
                this.elements.viewerTitle.innerHTML = `<i class="fas fa-book-reader"></i> ${topic}`;
                this.elements.contentWrapper.innerHTML = this.parseContent(content);
                if (window.renderMathInElement) {
                    window.renderMathInElement(this.elements.contentWrapper, {
                        delimiters: [{left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false}]
                    });
                }
                this.elements.backButton?.classList.add('show');
            },

            renderSearchResults() {
                const term = this.state.searchTerm.toLowerCase();
                this.elements.searchResultsTitle.innerHTML = `<i class="fas fa-search"></i> Results for "${this.state.searchTerm}"`;
                if (!this.elements.searchResultsList) return;

                this.elements.searchResultsList.innerHTML = '';
                const results = [];
                const data = this.state.transesData;

                for (const year in data) {
                    for (const semester in data[year]) {
                        for (const t in data[year][semester]) {
                            for (const subject in data[year][semester][t]) {
                                for (const topic in data[year][semester][t][subject]) {
                                    if (topic.toLowerCase().includes(term) || subject.toLowerCase().includes(term)) {
                                        results.push({ path: { year, semester, term: t, subject, topic } });
                                    }
                                }
                            }
                        }
                    }
                }

                if(results.length === 0) {
                    this.elements.searchResultsList.innerHTML = `<li>No topics found matching your search.</li>`;
                    return;
                }
                
                results.forEach(result => {
                    const li = document.createElement('li');
                    li.className = 'search-result-item';
                    const { year, semester, term, subject, topic } = result.path;
                    const pathString = `${year} &gt; ${semester} &gt; ${term} &gt; ${subject}`;
                    li.innerHTML = `<a href="#"><div class="search-result-topic">${topic}</div><div class="search-result-path">${pathString}</div></a>`;
                    li.querySelector('a')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.displayTopic(result.path);
                    });
                    this.elements.searchResultsList.appendChild(li);
                });
            },
            
            toggleBackToTopButton() {
                if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                    this.elements.backToTopButton?.classList.add('show');
                } else {
                    this.elements.backToTopButton?.classList.remove('show');
                }
            },

            parseContent(text) {
                if (!text) return '<div class="content-body"><p>Content not available for this topic.</p></div>';
                const boldTerm = (line) => line.replace(/^([A-Za-z\s/()]+:)/, '<strong>$1</strong>');
                let processedText = text.replace(/{([^}]+?)}/g, '$$$$$1$$$$');
                const lines = processedText.split('\n');
                let html = '<div class="content-body">';
                let listOpen = false;
                
                const closeList = () => { if (listOpen) { html += '</ul>'; listOpen = false; } };

                const parseNclexBlock = (rawBlock) => {
                    let cleanText = rawBlock.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
                    let questionStem = '', choicesHtml = '', answerText = '', rationaleText = '';
                    const answerPattern = /(Answer:.*?(?=Rationale:|$))/i;
                    const answerMatch = cleanText.match(answerPattern);
                    if (answerMatch) {
                        const preciseAnswerMatch = answerMatch[0].match(/(Answer:\s*(.*))/i);
                        if(preciseAnswerMatch){
                            answerText = `<strong>Answer:</strong> ${preciseAnswerMatch[2].trim()}`;
                            cleanText = cleanText.replace(answerMatch[0], '').trim();
                        }
                    }
                    const rationalePattern = /(Rationale:.*?(?=Answer:|$))/i;
                    const rationaleMatch = cleanText.match(rationalePattern);
                    if (rationaleMatch) {
                        rationaleText = `<strong>Rationale:</strong> ${rationaleMatch[0].substring(10).trim()}`;
                        cleanText = cleanText.replace(rationaleMatch[0], '').trim();
                    }
                    const firstChoiceIndex = cleanText.search(/\s[a-z]\)/i);
                    if (firstChoiceIndex > -1) {
                        questionStem = cleanText.substring(0, firstChoiceIndex).trim();
                        const choicesText = cleanText.substring(firstChoiceIndex).trim();
                        const choicesArray = choicesText.split(/(?=\s[a-z]\))/i);
                        choicesHtml = choicesArray.filter(c => c.trim()).map(c => `<p>${c.trim()}</p>`).join('');
                    } else {
                        questionStem = cleanText;
                    }
                    let blockHtml = '<div class="nclex-question-block">';
                    blockHtml += `<p class="question-stem">${questionStem.replace(/^(Multiple Choice:|SATA:|SATA \(Select All That Apply\):)\s*/i, '')}</p>`;
                    blockHtml += `<div class="choices">${choicesHtml}</div>`;
                    if (answerText) blockHtml += `<div class="answer-box"><p>${answerText}</p></div>`;
                    if (rationaleText) blockHtml += `<div class="rationale-box"><p>${rationaleText}</p></div>`;
                    blockHtml += '</div>';
                    return blockHtml;
                };

                lines.forEach(line => {
                    let trimmedLine = line.trim();
                    if (trimmedLine === '') return;
                    if (trimmedLine.match(/^(SATA:|Multiple Choice:|SATA \(Select All That Apply\):)/i)) { closeList(); html += parseNclexBlock(trimmedLine); } 
                    else if (trimmedLine.match(/^([IVX]+|[0-9]+)\.\s/)) { closeList(); html += `<h2>${trimmedLine}</h2>`; }
                    else if (trimmedLine.match(/^[A-Z]\.\s/)) { closeList(); html += `<h3>${trimmedLine}</h3>`; } 
                    else if (trimmedLine.startsWith('[INFO]')) { closeList(); html += `<div class="info-box info"><p>${boldTerm(trimmedLine.substring(6).trim())}</p></div>`; }
                    else if (trimmedLine.startsWith('[PRIORITY]')) { closeList(); html += `<div class="info-box priority"><p>${boldTerm(trimmedLine.substring(10).trim())}</p></div>`; }
                    else if (trimmedLine.startsWith('[MNEMONIC]')) { closeList(); html += `<div class="info-box mnemonic"><p>${boldTerm(trimmedLine.substring(10).trim())}</p></div>`; }
                    else if (trimmedLine.startsWith('* ')) { if (!listOpen) { html += '<ul>'; listOpen = true; } html += `<li>${boldTerm(trimmedLine.substring(2))}</li>`; } 
                    else { closeList();
                        if (trimmedLine.length < 60 && trimmedLine === trimmedLine.toUpperCase() && !trimmedLine.includes(':')) html += `<h1>${trimmedLine}</h1>`;
                        else html += `<p>${boldTerm(trimmedLine)}</p>`;
                    }
                });
                
                closeList();
                html += '</div>';
                return html;
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>